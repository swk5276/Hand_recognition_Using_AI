<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <title>Follow & Predict</title>
  <style>
    body { font-family: system-ui, sans-serif; margin: 20px; }
    .row { display: flex; gap: 24px; }
    .card { border: 1px solid #ddd; border-radius: 10px; padding: 16px; }
    canvas { border: 1px solid #aaa; border-radius: 6px; cursor: crosshair; }
    button { padding: 8px 14px; border-radius: 8px; border: 1px solid #888; background: #f7f7f7; }
  </style>
</head>
<body>
  <h2>타깃 글자를 보고 따라 그리세요</h2>
  <p>Target Class: <strong>{{ target_label }}</strong></p>

  <div class="row">
    <div class="card">
      <h4>참고 이미지</h4>
      <img src="data:image/png;base64,{{ ref_b64 }}" width="256" height="256" />
    </div>

    <div class="card">
      <h4>그리기</h4>
      <canvas id="pad" width="256" height="256"></canvas>
      <div style="margin-top:10px;">
        <button id="clearBtn" type="button">지우기</button>
        <button id="submitBtn" type="button">예측하기</button>
      </div>
      <form id="sendForm" method="post" action="">
        {% csrf_token %}
        <input type="hidden" name="png_data" id="png_data" />
        <input type="hidden" name="target_label" value="{{ target_label }}" />
      </form>
    </div>

    {% if user_b64 %}
    <div class="card">
      <h4>내가 그린 그림</h4>
      <img src="data:image/png;base64,{{ user_b64 }}" width="256" height="256" />
    </div>
    {% endif %}
  </div>

  {% if result %}
  <div class="card" style="margin-top:20px;">
    <h3>예측 결과</h3>
    <p>Predicted Class: <strong>{{ result.pred_class }}</strong></p>
    <p>정답 여부: <strong style="color:{{ 'green' if result.correct else 'red' }}">{{ '정답' if result.correct else '오답' }}</strong></p>
    <h4>Top-5</h4>
    <ul>
      {% for cls, prob in result.top5 %}
        <li>class {{ cls }} — {{ prob|floatformat:4 }}</li>
      {% endfor %}
    </ul>
    <a href="?">다른 타깃으로 다시 시도</a>
  </div>
  {% endif %}

  <script>
    const pad = document.getElementById('pad');
    const ctx = pad.getContext('2d');
    // 흰 배경
    ctx.fillStyle = '#ffffff';
    ctx.fillRect(0,0,pad.width,pad.height);

    let drawing = false;
    let last = null;

    function pos(e){
      const rect = pad.getBoundingClientRect();
      const x = (e.touches ? e.touches[0].clientX : e.clientX) - rect.left;
      const y = (e.touches ? e.touches[0].clientY : e.clientY) - rect.top;
      return {x, y};
    }

    function start(e){
      drawing = true; last = pos(e);
      e.preventDefault();
    }
    function move(e){
      if(!drawing) return;
      const p = pos(e);
      ctx.strokeStyle = '#000000';
      ctx.lineWidth = 16;
      ctx.lineCap = 'round';
      ctx.beginPath();
      ctx.moveTo(last.x, last.y);
      ctx.lineTo(p.x, p.y);
      ctx.stroke();
      last = p;
      e.preventDefault();
    }
    function end(e){ drawing = false; e.preventDefault(); }

    pad.addEventListener('mousedown', start);
    pad.addEventListener('mousemove', move);
    pad.addEventListener('mouseup', end);
    pad.addEventListener('mouseleave', end);
    pad.addEventListener('touchstart', start, {passive:false});
    pad.addEventListener('touchmove', move, {passive:false});
    pad.addEventListener('touchend', end);

    document.getElementById('clearBtn').onclick = () => {
      ctx.fillStyle = '#ffffff';
      ctx.fillRect(0,0,pad.width,pad.height);
    };

    document.getElementById('submitBtn').onclick = () => {
      // 캔버스 전체를 PNG data URL로
      const dataURL = pad.toDataURL('image/png');
      document.getElementById('png_data').value = dataURL;
      document.getElementById('sendForm').submit();
    };
  </script>
</body>
</html>
